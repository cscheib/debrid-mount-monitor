# Release Workflow - Docker Job (Updated)
# ========================================
# This is the replacement for Job 4 in .github/workflows/release.yml
# Changes from original:
#   1. Downloads pre-built binaries instead of checking out source
#   2. Uses Dockerfile.release instead of Dockerfile
#   3. No Go compilation occurs during Docker build
#   4. Version is preserved from binary (already embedded in build job)

# ============================================================
# Job 4: Build and Push Docker Image (Updated)
# FR-007: Build multi-architecture Docker images
# FR-008: Push to ghcr.io with version tag
# FR-009: Update latest tag only for stable releases
# FR-016: Retry failed steps up to 2 times
# NEW: Uses pre-built binaries from build job
# ============================================================
docker:
  name: Docker Build & Push
  runs-on: ubuntu-latest
  needs: verify
  steps:
    - name: Determine version and pre-release status
      id: meta
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${{ github.ref_name }}"
        fi
        echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT

        # FR-010: Detect pre-release (contains '-' after semver)
        if [[ "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+-.+$ ]]; then
          echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
        else
          echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
        fi

    # NEW: Download pre-built binaries from build job
    - name: Download amd64 binary
      uses: actions/download-artifact@v6
      with:
        name: mount-monitor-linux-amd64
        path: ./docker-context/

    - name: Download arm64 binary
      uses: actions/download-artifact@v6
      with:
        name: mount-monitor-linux-arm64
        path: ./docker-context/

    # NEW: Checkout only needed for Dockerfile.release
    - name: Checkout Dockerfile.release
      uses: actions/checkout@v6
      with:
        sparse-checkout: |
          Dockerfile.release
        sparse-checkout-cone-mode: false

    - name: Copy Dockerfile to context
      run: cp Dockerfile.release ./docker-context/

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to ghcr.io
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    # UPDATED: Use docker-context directory and Dockerfile.release
    - name: Build and push with retry
      uses: nick-fields/retry@v3
      with:
        timeout_minutes: 15
        max_attempts: 3
        retry_wait_seconds: 30
        command: |
          # Build tags list
          TAGS="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.VERSION }}"
          if [ "${{ steps.meta.outputs.IS_PRERELEASE }}" == "false" ]; then
            TAGS="${TAGS},${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          fi

          # Build from docker-context directory using Dockerfile.release
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            --push \
            --tag ${TAGS} \
            --file ./docker-context/Dockerfile.release \
            ./docker-context/
