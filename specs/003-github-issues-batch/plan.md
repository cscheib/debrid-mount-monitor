# Implementation Plan: GitHub Issues Batch Implementation

**Branch**: `003-github-issues-batch` | **Date**: 2025-12-15 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/003-github-issues-batch/spec.md`

## Summary

Batch implementation of 5 GitHub issues focused on security hardening and code quality improvements, plus closing 6 issues as "won't do". All changes are incremental improvements to the existing Go codebase with no new dependencies or architectural changes.

## Technical Context

**Language/Version**: Go 1.21+ (required for log/slog structured logging)
**Primary Dependencies**: Standard library only (no external dependencies)
**Storage**: N/A (configuration file is read-only input)
**Testing**: Go testing (`go test ./...`)
**Target Platform**: Linux (primary), macOS (development), Windows (supported)
**Project Type**: single
**Performance Goals**: Eliminate per-log-call allocations in multiStreamHandler
**Constraints**: Must maintain backwards compatibility with existing configurations
**Scale/Scope**: 5 small code changes across 4 files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Minimal Dependencies | ✅ PASS | All implementations use standard library only (`runtime`, `log/slog`) |
| II. Single Static Binary | ✅ PASS | No changes to build output |
| III. Cross-Platform Compilation | ✅ PASS | Permission check uses `runtime.GOOS` for platform-specific behavior |
| IV. Signal Handling | ✅ PASS | No changes to signal handling |
| V. Container Sidecar Design | ✅ PASS | Logging still goes to stdout/stderr |
| VI. Fail-Safe Orchestration | ✅ PASS | Config rejection on oversized files is fail-safe behavior |

**Gate Result**: ✅ All gates pass. No violations requiring justification.

## Project Structure

### Documentation (this feature)

```text
specs/003-github-issues-batch/
├── plan.md              # This file
├── research.md          # Phase 0 output (minimal - no unknowns)
├── spec.md              # Feature specification
└── tasks.md             # Phase 2 output
```

### Source Code (repository root)

```text
cmd/
└── mount-monitor/
    └── main.go          # #12: Cache slog handlers

internal/
├── config/
│   ├── config.go        # #8: Improve error message
│   └── file.go          # #17: File size limit, #15: Permission warning
└── health/
    └── checker.go       # #7: Document goroutine leak

tests/
└── unit/
    └── config_file_test.go  # New tests for file size limit
```

**Structure Decision**: Single project structure (existing). All changes are modifications to existing files, no new directories required.

## Complexity Tracking

> No violations to justify. All implementations align with constitution principles.

N/A - All gates pass.

## Implementation Phases

### Phase 0: Research (Minimal)

No research required. All implementations use well-understood Go standard library patterns:
- `os.Stat()` for file size check (already used in codebase)
- `runtime.GOOS` for platform detection (standard Go idiom)
- Pre-creating slog handlers (standard optimization pattern)

### Phase 1: Design

**Data Model Changes**: None required. This feature only modifies behavior, not data structures.

**API Contract Changes**: None. No external API changes.

**Key Implementation Decisions**:

1. **File Size Limit (#17)**
   - Use existing `os.Stat()` call result instead of adding another system call
   - Define constant `maxConfigFileSize = 1 << 20` (1MB)
   - Return error before reading file content

2. **Permission Warning (#15)**
   - Check `runtime.GOOS != "windows"` before permission check
   - Use `info.Mode().Perm()&0002` to detect world-writable
   - Log warning via `slog.Warn()`, continue loading (non-blocking)

3. **Handler Caching (#12)**
   - Pre-create stdout and stderr handlers in `setupLogger()`
   - Store in struct fields instead of recreating per `Handle()` call
   - Reduces allocations from O(n) per log to O(1) at startup

4. **Error Message (#8)**
   - Single line change: append explanation to existing error string

5. **Documentation (#7)**
   - Add comprehensive comment block explaining goroutine leak limitation
   - Include rationale for why it's acceptable

### Phase 2: Tasks

See `tasks.md` (generated by `/speckit.tasks`)

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Breaking existing configs | Low | High | File size limit (1MB) is generous; typical configs are <10KB |
| Performance regression | Very Low | Low | Handler caching improves performance, doesn't degrade it |
| Platform-specific bugs | Low | Medium | Permission check explicitly skipped on Windows |

## Dependencies

**Implementation Order** (no blocking dependencies):
1. #8 and #7 can be done in any order (trivial changes)
2. #17 and #15 should be done together (both modify `file.go`)
3. #12 can be done independently
4. Issue closures can be done in parallel with any implementation

## Verification

- [ ] `go test ./...` passes
- [ ] `go vet ./...` passes
- [ ] `go build ./...` succeeds
- [ ] Manual test: Config > 1MB rejected
- [ ] Manual test: World-writable config generates warning
