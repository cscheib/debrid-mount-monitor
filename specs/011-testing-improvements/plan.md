# Implementation Plan: Testing Quality Improvements

**Branch**: `011-testing-improvements` | **Date**: 2025-12-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-testing-improvements/spec.md`

## Summary

Improve test quality and effectiveness by adding goroutine leak detection (goleak), expanding unit test coverage (watchdog 45%→80%, main.go 0%→60%), creating shared test utilities, enhancing CI coverage reporting, and expanding KIND E2E tests for mount failure scenarios. The `-race` flag is already enabled in CI.

## Technical Context

**Language/Version**: Go 1.21+ (required for log/slog structured logging)
**Primary Dependencies**: Standard library + goleak (test-only, zero transitive deps)
**Storage**: N/A (testing infrastructure, no persistent storage)
**Testing**: go test + goleak + `-race` flag + coverage tools (all stdlib except goleak)
**Target Platform**: Linux (amd64, arm64), macOS (development)
**Project Type**: Single project (existing Go binary with test suite)
**Performance Goals**: Test execution with race detection < 5x normal test time
**Constraints**: Constitution compliance (minimal deps, no CGO, test-only additions)
**Scale/Scope**: ~8 existing test files, target 75%+ overall coverage

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Minimal Dependencies | ✅ PASS | goleak has zero transitive deps, test-only |
| II. Single Static Binary | ✅ PASS | No production impact (test-only) |
| III. Cross-Platform Compilation | ✅ PASS | No CGO, works on arm64/amd64 |
| IV. Signal Handling | ⚪ N/A | Testing infrastructure |
| V. Container Sidecar Design | ⚪ N/A | Testing infrastructure |
| VI. Fail-Safe Orchestration | ⚪ N/A | Testing infrastructure |

**New Dependency Justification (goleak)**:
- **Problem**: Detecting goroutine leaks in tests (documented concern with hung NFS mounts)
- **Why stdlib insufficient**: No built-in goroutine leak detection
- **Transitive deps**: Zero
- **Maintenance**: Actively maintained by Uber
- **Binary impact**: Zero (test-only)
- **CGO**: None required

**Verdict**: ✅ All gates pass. Proceed with implementation.

## Project Structure

### Documentation (this feature)

```text
specs/011-testing-improvements/
├── plan.md              # This file
├── research.md          # Phase 0: goleak patterns, testing best practices
├── data-model.md        # Phase 1: Test entities and coverage model
├── quickstart.md        # Phase 1: Developer testing guide
└── tasks.md             # Phase 2: Implementation tasks (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
# Existing structure (additions marked with +)
internal/
├── config/
│   ├── config.go
│   ├── config_test.go
│   └── file_test.go
├── health/
│   ├── checker.go
│   ├── checker_test.go    # + concurrent access tests
│   ├── state.go
│   └── state_test.go      # + concurrent access tests
├── monitor/
│   ├── monitor.go
│   └── monitor_test.go    # + notification ordering tests
├── server/
│   ├── server.go
│   └── server_test.go     # + lifecycle tests (Start/Shutdown)
├── watchdog/
│   ├── k8s_client.go
│   ├── watchdog.go
│   └── watchdog_test.go   # + expanded coverage (45%→80%)
└── testutil/              # + NEW: shared test utilities
    ├── logger.go          # + testutil.Logger()
    ├── config.go          # + testutil.TempConfig()
    └── poll.go            # + testutil.PollUntil()

cmd/mount-monitor/
├── main.go                # + extract testable functions
└── main_test.go           # + NEW: entry point tests

tests/
├── integration/
│   └── shutdown_test.go
└── e2e/                   # + NEW: E2E test scenarios
    └── mount_failure_test.go

.github/workflows/
└── ci.yml                 # + coverage reporting (already has -race)

Makefile                   # + test-race, test-cover targets
go.mod                     # + goleak dependency
```

**Structure Decision**: Extend existing single-project structure. Add `internal/testutil/` for shared test helpers and `tests/e2e/` for new E2E scenarios.

## Complexity Tracking

> No constitution violations requiring justification.

| Aspect | Decision | Rationale |
|--------|----------|-----------|
| goleak dependency | Add to go.mod | Meets all approval criteria; test-only |
| testutil package | internal/testutil/ | Consistent with existing internal/ structure |
| E2E tests | tests/e2e/ | Separate from unit/integration tests |

## Implementation Phases

### Phase 1: Test Infrastructure & Tooling

1. **Add goleak dependency**
   - `go get -t go.uber.org/goleak`
   - Verify zero transitive deps: `go mod graph | grep goleak`

2. **Create testutil package**
   - `internal/testutil/logger.go`: Silent test logger factory
   - `internal/testutil/config.go`: Temp config file helper
   - `internal/testutil/poll.go`: Generic polling with timeout

3. **Update Makefile**
   - Add `test-race`: `go test -race ./...`
   - Add `test-cover`: Generate HTML coverage report
   - Add `test-all`: Combined race + coverage

4. **Update CI workflow**
   - Add coverage artifact upload
   - Add coverage summary comment on PRs (optional)

### Phase 2: Unit Test Coverage Expansion

5. **Watchdog tests** (45%→80%): `internal/watchdog/watchdog_test.go`
   - Timer cancellation on recovery
   - Concurrent mount state changes
   - API retry exhaustion → process exit
   - Pod-already-terminating edge case

6. **main.go tests** (0%→60%): `cmd/mount-monitor/main_test.go`
   - Extract `setupLogger()` as testable function
   - Test stdout/stderr routing
   - Test `runInitMode()` with temp mounts
   - Test shutdown coordination

7. **Server lifecycle tests**: `internal/server/server_test.go`
   - `Server.Start()` binding
   - `Server.Shutdown()` graceful handling
   - In-flight request completion

8. **Config edge cases**: `internal/config/file_test.go`
   - File permission validation
   - Malformed JSON handling
   - Size limit enforcement

### Phase 3: Integration & Concurrency Testing

9. **Add goleak to critical tests**
   - Watchdog tests (goroutine-heavy)
   - Monitor tests (uses goroutines per mount)
   - Server tests (HTTP handlers)

10. **Concurrent access tests**: `internal/health/state_test.go`
    - Multiple goroutines reading/writing State
    - Verify RWMutex correctness

11. **Monitor notification tests**: `internal/monitor/monitor_test.go`
    - Watchdog notification ordering
    - Recovery cancellation timing

### Phase 4: E2E Test Expansion

12. **Mount failure scenarios**: `tests/e2e/mount_failure_test.go`
    - Canary removal → unhealthy detection
    - Recovery → restart cancellation
    - Pod deletion → event creation

13. **KIND test enhancements**: `scripts/kind-e2e-test.sh`
    - Add recovery verification
    - Add concurrent mount failure test
    - Add restart timing validation

## Files to Modify

| File | Changes |
|------|---------|
| `go.mod` | Add `go.uber.org/goleak` |
| `Makefile` | Add test-race, test-cover, test-all targets |
| `.github/workflows/ci.yml` | Add coverage artifact upload |
| `internal/testutil/logger.go` | NEW: Logger() helper |
| `internal/testutil/config.go` | NEW: TempConfig() helper |
| `internal/testutil/poll.go` | NEW: PollUntil() helper |
| `internal/watchdog/watchdog_test.go` | Expand coverage 45%→80% |
| `internal/server/server_test.go` | Add lifecycle tests |
| `internal/config/file_test.go` | Add edge case tests |
| `internal/health/state_test.go` | Add concurrent access tests |
| `internal/monitor/monitor_test.go` | Add notification ordering tests |
| `cmd/mount-monitor/main.go` | Extract testable functions |
| `cmd/mount-monitor/main_test.go` | NEW: Entry point tests |
| `tests/e2e/mount_failure_test.go` | NEW: E2E scenarios |
| `scripts/kind-e2e-test.sh` | Add recovery/timing tests |

## Success Validation

| Metric | Baseline | Target | Validation Command |
|--------|----------|--------|-------------------|
| Overall coverage | 57% | 75%+ | `go test -coverprofile=c.out ./... && go tool cover -func=c.out` |
| Watchdog coverage | 45% | 80%+ | `go test -coverprofile=c.out ./internal/watchdog/... && go tool cover -func=c.out` |
| main.go coverage | 0% | 60%+ | `go test -coverprofile=c.out ./cmd/... && go tool cover -func=c.out` |
| Race conditions | ? | 0 | `go test -race ./...` |
| Goroutine leaks | ? | 0 | Tests with goleak.VerifyNone(t) |
| E2E scenarios | Basic | 3+ | `make kind-test` |
